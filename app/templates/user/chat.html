{% extends "base_sidebar.html" %}

{% block title %}Chat con Agente BMC - Bedrock Agent{% endblock %}

{% block main %}
<div class="dashboard-container">
    <!-- Header del Chat -->
    <div class="dashboard-header">
        <h1><i class="fas fa-comments"></i> Chat con Agente BMC</h1>
        <p class="dashboard-subtitle">Bienvenido, <strong>{{ current_user.email }}</strong></p>
    </div>

    <!-- Información del Agente -->
    <div class="card" style="background: #f8fafc; border: 2px solid #e2e8f0; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin: 0; color: #1e293b; font-weight: 600;"><i class="fas fa-robot"></i> Agente BMC Personalizado</h3>
                <p style="margin: 4px 0 0 0; color: #64748b;">
                    Conectado a Amazon Bedrock Agent con Knowledge Base
                </p>
            </div>
            <div style="background: #2c5d9cff; color: #7fffd4; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem;">
                <i class="fas fa-brain"></i> Knowledge Base Activa
            </div>
        </div>
    </div>

    <!-- Controles del Chat -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>Agente:</strong> 
                <span style="color: #3b82f6; font-weight: 600;">Bedrock Agent Personalizado</span>
                <span id="agent-status" style="margin-left: 8px; padding: 4px 8px; background: #2c5d9cff; color: #7fffd4; border-radius: 4px; font-size: 0.8rem;">
                    <i class="fas fa-circle"></i> Conectado
                </span>
            </div>
            <div style="display: flex; gap: 8px;">
                <button id="agent-info" class="btn btn-outline" style="width: auto; padding: 8px 12px;">
                    <i class="fas fa-info-circle"></i> Info Agente
                </button>
                <button id="clear-chat" class="btn btn-outline" style="width: auto; padding: 8px 16px;">
                    <i class="fas fa-trash"></i> Limpiar Chat
                </button>
            </div>
        </div>
    </div>

    <!-- Historial de Mensajes -->
    <div id="chat-messages" class="card" style="height: 400px; border: 1px solid #e2e8f0; padding: 20px; margin-bottom: 20px; overflow-y: auto; background: white;">
        <!-- Mensaje de bienvenida -->
        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
            <div style="display: flex; align-items: start; gap: 12px;">
                <div style="background: #2c5d9cff; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; color: #7fffd4;">
                    <i class="fas fa-robot"></i> AGENTE BMC
                </div>
                <div style="flex: 1;">
                    <strong>Agente Especializado:</strong> ¡Hola {{ current_user.email }}! Soy tu agente especializado de BMC con acceso a la documentación completa del sistema. Puedo ayudarte con:
                    <ul style="margin: 12px 0; padding-left: 20px; color: #475569;">
                        <li>Consultas sobre funcionalidades específicas</li>
                        <li>Procedimientos documentados en la Knowledge Base</li>
                        <li>Configuraciones del sistema</li>
                        <li>Y mucho más usando la documentación actualizada</li>
                    </ul>
                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 12px; padding: 8px; background: rgba(45, 90, 77, 0.1); border-radius: 4px;">
                        <i class="fas fa-bolt"></i> <strong>Powered by:</strong> Amazon Bedrock Agent + Knowledge Base
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Formulario de Mensaje -->
    <form id="chat-form" class="card" style="padding: 20px;">
        <div style="display: flex; gap: 12px;">
            <input type="text" name="message" id="message-input" class="input" 
                   placeholder="Escribe tu pregunta para el agente especializado..." style="flex: 1;" 
                   required autocomplete="off">
            <button type="submit" class="btn" style="width: auto; background: #2c5d9cff; border-color: #2c5d9cff;" id="send-button">
                <span id="send-text"><i class="fas fa-paper-plane"></i> Enviar</span>
                <span id="loading-spinner" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Consultando...</span>
            </button>
        </div>
    </form>
    
    <!-- Ejemplos de Preguntas -->
    <div class="card" style="margin-top: 20px;">
        <h4 style="margin: 0 0 16px 0; color: #1e293b;"><i class="fas fa-lightbulb"></i> Ejemplos de consultas para la Knowledge Base:</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
            <button class="btn btn-outline" style="text-align: left; padding: 12px;" 
                    onclick="setExample('¿Qué procedimientos hay para la carga de documentos?')">
                <i class="fas fa-upload"></i> Procedimientos de documentos
            </button>
            <button class="btn btn-outline" style="text-align: left; padding: 12px;" 
                    onclick="setExample('Explícame las funcionalidades de administración')">
                <i class="fas fa-users-cog"></i> Funcionalidades admin
            </button>
            <button class="btn btn-outline" style="text-align: left; padding: 12px;" 
                    onclick="setExample('¿Cómo configurar los permisos de usuario?')">
                <i class="fas fa-cog"></i> Configuración permisos
            </button>
        </div>
    </div>
</div>

<script>
let isLoading = false;

// Cargar historial al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadChatHistory();
    checkAgentStatus();
});

function setExample(question) {
    document.getElementById('message-input').value = question;
    document.getElementById('message-input').focus();
}

function checkAgentStatus() {
    fetch('/api/chat/agent-info')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('agent-status');
            if (data.success) {
                statusElement.innerHTML = `<i class="fas fa-circle"></i> ${data.agent_status} - ${data.agent_name}`;
                statusElement.style.background = '#2c5d9cff';
            } else {
                statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error de conexión';
                statusElement.style.background = '#dc2626';
            }
        })
        .catch(error => {
            console.error('Error checking agent status:', error);
        });
}

function loadChatHistory() {
    fetch('/api/chat/history')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayChatHistory(data.history);
            }
        })
        .catch(error => {
            console.error('Error cargando historial:', error);
        });
}

function displayChatHistory(history) {
    const container = document.getElementById('chat-messages');
    // Mantener el mensaje de bienvenida inicial
    const welcomeMessage = container.innerHTML;
    container.innerHTML = welcomeMessage;
    
    history.forEach(msg => {
        if (!msg.is_user && msg.content.includes('¡Hola')) {
            return; // Saltar mensaje de bienvenida duplicado
        }
        addMessageToChat(msg.content, msg.is_user ? 'user' : 'assistant', false);
    });
    
    scrollToBottom();
}

function addMessageToChat(message, role, animate = true, citations = false) {
    const container = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    
    if (role === 'user') {
        messageDiv.innerHTML = `
            <div style="background: #3b82f6; color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; margin-left: 20%; text-align: right;">
                <div style="display: flex; align-items: start; gap: 12px; justify-content: flex-end;">
                    <div style="flex: 1;">
                        <strong><i class="fas fa-user"></i> Tú:</strong> ${escapeHtml(message)}
                    </div>
                    <div style="background: #1e40af; padding: 6px 10px; border-radius: 4px; font-size: 0.8rem;">
                        <i class="fas fa-user"></i> Tú
                    </div>
                </div>
            </div>
        `;
    } else {
        let citationBadge = '';
        if (citations) {
            citationBadge = '<span style="background: #2d5a4d; color: #7fffd4; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px;"><i class="fas fa-book"></i> KB</span>';
        }
        
        messageDiv.innerHTML = `
            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #2c5d9cff;">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="background: #2c5d9cff; padding: 6px 10px; border-radius: 6px; font-size: 0.9rem; color: #7fffd4;">
                        <i class="fas fa-robot"></i> AGENTE
                    </div>
                    <div style="flex: 1;">
                        <strong>Agente Especializado:</strong> ${escapeHtml(message)} ${citationBadge}
                        <div style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">
                            <i class="fas fa-bolt"></i> Powered by Amazon Bedrock Agent + Knowledge Base
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (animate) {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(10px)';
    }
    
    container.appendChild(messageDiv);
    
    if (animate) {
        setTimeout(() => {
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateY(0)';
        }, 10);
    }
    
    scrollToBottom();
}

function showTypingIndicator() {
    const container = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = `
        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #2d64a3ff;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="background: #2e5ea5ff; padding: 6px 10px; border-radius: 6px; font-size: 0.9rem; color: #7fffd4;">
                    <i class="fas fa-robot"></i> AGENTE
                </div>
                <div style="display: flex; align-items: center; gap: 6px; color: #64748b; font-style: italic;">
                    <i class="fas fa-spinner fa-spin"></i> Consultando Knowledge Base
                    <span style="display: inline-flex; gap: 2px;">
                        <span style="width: 4px; height: 4px; background: #64748b; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out;"></span>
                        <span style="width: 4px; height: 4px; background: #64748b; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; animation-delay: 0.2s;"></span>
                        <span style="width: 4px; height: 4px; background: #64748b; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; animation-delay: 0.4s;"></span>
                    </span>
                </div>
            </div>
        </div>
    `;
    container.appendChild(typingDiv);
    scrollToBottom();
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function scrollToBottom() {
    const container = document.getElementById('chat-messages');
    container.scrollTop = container.scrollHeight;
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;")
        .replace(/\n/g, '<br>');
}

// Manejar envío de mensajes
document.getElementById('chat-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (isLoading) return;
    
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (message) {
        // Agregar mensaje del usuario al chat
        addMessageToChat(message, 'user');
        messageInput.value = '';
        
        // Mostrar indicador de typing
        showTypingIndicator();
        
        // Deshabilitar formulario
        isLoading = true;
        document.getElementById('send-button').disabled = true;
        document.getElementById('send-text').style.display = 'none';
        document.getElementById('loading-spinner').style.display = 'inline';
        
        // Enviar mensaje al servidor
        fetch('/api/chat/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            
            if (data.success) {
                addMessageToChat(data.response, 'assistant', true, data.has_citations);
                if (data.has_citations) {
                    console.log('Respuesta con', data.citations_count, 'citaciones de la Knowledge Base');
                }
            } else {
                addMessageToChat(`<i class="fas fa-exclamation-triangle"></i> Error del agente: ${data.error}`, 'assistant');
            }
        })
        .catch(error => {
            hideTypingIndicator();
            addMessageToChat(`<i class="fas fa-exclamation-triangle"></i> Error de conexión: ${error}`, 'assistant');
        })
        .finally(() => {
            // Rehabilitar formulario
            isLoading = false;
            document.getElementById('send-button').disabled = false;
            document.getElementById('send-text').style.display = 'inline';
            document.getElementById('loading-spinner').style.display = 'none';
            messageInput.focus();
        });
    }
});

// Info del agente
document.getElementById('agent-info').addEventListener('click', function() {
    fetch('/api/chat/agent-info')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Información del Agente:\n\n` +
                      `Nombre: ${data.agent_name}\n` +
                      `Estado: ${data.agent_status}\n` +
                      `Alias: ${data.agent_alias}\n` +
                      `Knowledge Base: ${data.knowledge_base_id || 'N/A'}`);
            } else {
                alert('Error obteniendo info del agente: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error de conexión: ' + error);
        });
});

// Limpiar chat
document.getElementById('clear-chat').addEventListener('click', function() {
    if (confirm('¿Estás seguro de que quieres limpiar todo el historial de chat?')) {
        fetch('/api/chat/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('chat-messages');
                // Mantener solo el mensaje de bienvenida
                const welcomeMessage = container.querySelector('.bot-message');
                container.innerHTML = '';
                if (welcomeMessage) {
                    container.appendChild(welcomeMessage);
                }
            } else {
                alert('Error limpiando chat: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error de conexión: ' + error);
        });
    }
});

// Auto-focus en el input
document.getElementById('message-input').focus();
</script>
{% endblock %}