{% extends "base_sidebar.html" %}

{% block title %}Gesti√≥n de Usuarios - BMC{% endblock %}

{% block main %}
<div class="card">
    <h1>üë• Gesti√≥n de Usuarios</h1>
    <p class="subtitle">Administra los usuarios registrados en el sistema</p>
    
    <!-- Estad√≠sticas R√°pidas -->
    <div class="row">
        <div class="card" style="flex: 1; text-align: center;">
            <h3>Total Usuarios</h3>
            <p style="font-size: 2rem; margin: 0; color: #7fb6ff;">{{ users|length }}</p>
        </div>
        
        <div class="card" style="flex: 1; text-align: center;">
            <h3>Administradores</h3>
            <p style="font-size: 2rem; margin: 0; color: #7fffd4;">
                {{ users|selectattr("role", "equalto", "admin")|list|length }}
            </p>
        </div>
        
        <div class="card" style="flex: 1; text-align: center;">
            <h3>Usuarios Normales</h3>
            <p style="font-size: 2rem; margin: 0; color: #dbc7ff;">
                {{ users|selectattr("role", "equalto", "user")|list|length }}
            </p>
        </div>
    </div>

    <!-- Lista de Usuarios -->
    <div class="card mt-2">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0;">Lista de Usuarios</h3>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline" style="width: auto;">
                ‚Üê Volver al Dashboard
            </a>
        </div>
        
        {% if users %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: var(--input);">
                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--outline);">Email</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--outline);">Rol</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--outline);">Fecha de Registro</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--outline);">ID</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--outline);">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr style="border-bottom: 1px solid var(--outline);">
                        <td style="padding: 12px;">
                            <strong>{{ user.email }}</strong>
                            {% if user.email == current_user.email %}
                            <span style="color: #7fffd4; font-size: 0.8rem; margin-left: 8px;">(T√∫)</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px;">
                            <span style="padding: 4px 8px; border-radius: 6px; 
                                {% if user.role == 'admin' %}background: #2d5a4d; color: #7fffd4;{% else %}background: #355b6f; color: #7fb6ff;{% endif %}">
                                {{ user.role }}
                            </span>
                        </td>
                        <td style="padding: 12px; color: var(--muted); font-size: 0.9rem;">
                            {% if user.created_at %}
                                {{ user.created_at[:10] }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td style="padding: 12px; color: var(--muted); font-size: 0.8rem; font-family: monospace;">
                            {{ user.id[:8] }}...
                        </td>
                        <td style="padding: 12px;">
                            <div style="display: flex; gap: 8px;">
                                {% if user.email != current_user.email %}
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem;">
                                    Editar
                                </button>
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem; background: #6a3654; border-color: #6a3654;">
                                    Eliminar
                                </button>
                                {% else %}
                                <span style="color: var(--muted); font-size: 0.8rem;">Tu cuenta</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-2" style="color: var(--muted); font-size: 0.9rem; text-align: center;">
            Total: {{ users|length }} usuario(s) registrado(s)
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: var(--muted);">
            <p style="font-size: 1.2rem;">No hay usuarios registrados</p>
            <p class="subtitle">Los usuarios aparecer√°n aqu√≠ despu√©s de registrarse</p>
            <a href="{{ url_for('auth.register') }}" class="btn" style="width: auto; margin-top: 16px;">
                Crear primer usuario
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Funciones de Administraci√≥n -->
    <div class="row mt-2">
        <div class="card" style="flex: 1;">
            <h3>üîÑ Cambiar Roles</h3>
            <p>Promover usuarios a administrador o degradar a usuario normal</p>
            <form method="post" style="margin-top: 12px;">
                <select class="input" name="user_email" style="margin-bottom: 8px;">
                    <option value="">Seleccionar usuario</option>
                    {% for user in users %}
                    {% if user.email != current_user.email %}
                    <option value="{{ user.email }}">{{ user.email }} ({{ user.role }})</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <select class="input" name="new_role" style="margin-bottom: 8px;">
                    <option value="user">Usuario Normal</option>
                    <option value="admin">Administrador</option>
                </select>
                <button type="submit" class="btn btn-outline" style="width: 100%;">Cambiar Rol</button>
            </form>
        </div>
        
        <div class="card" style="flex: 1;">
            <h3>üìä Exportar Datos</h3>
            <p>Exportar lista de usuarios en diferentes formatos</p>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="btn btn-outline" style="flex: 1;">CSV</button>
                <button class="btn btn-outline" style="flex: 1;">JSON</button>
                <button class="btn btn-outline" style="flex: 1;">PDF</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}